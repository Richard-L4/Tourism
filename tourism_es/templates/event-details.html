{% extends 'base.html' %}
{% load static %}
{% load comment_tags %}

{% block title %}
Valencia | Events-Details
{% endblock %}

{% block content %}
<h1 class="color">Welcome to The Valencia Project</h1>

<p class="color">The Event Details Page</p>

<main class="card-detail-wrapper">
    <div class="card-detail">
        <img src="{% static 'images/' %}{{ card.image_name }}" alt="{{ card.title }}" />
        <p>
            <a class="color-return" href="{% url 'index' %}">Return Home</a>
        </p>

        <div class="card-content-box">
            <h1>{{ card.title }}</h1>
            <p>{{ content }}</p>

            <div class="lang-switch">
                <a href="{% url 'event-details' pk=card.pk %}?lang=en">English</a>
                <a href="{% url 'event-details' pk=card.pk %}?lang=es">EspaÃ±ol</a>
            </div>

            <div class="rating-box">
                <h3>Event Rating</h3>

                <p>
                    â­ Average:
                    {% if average_rating %}
                        {{ average_rating|floatformat:1 }}
                    {% else %}
                        No ratings yet
                    {% endif %}
                    {% if rating_count %}
                        ({{ rating_count }} rating{{ rating_count|pluralize }})
                    {% endif %}
                </p>

                {% if user.is_authenticated %}
                <form method="POST" class="star-form" data-url="{% url 'rate_card' pk=card.id %}">
                    {% csrf_token %}
                    <div class="star-rating">
                        {% for star in "12345"|make_list %}
                        <button type="button" name="rating" value="{{ star }}"
                            class="star-btn {% if user_rating and user_rating.rating == star|add:'0' %}selected{% endif %}">
                            â˜…
                        </button>
                        {% endfor %}
                    </div>
                    <small class="rating-msg">
                        {% if user_rating %}
                            Your rating: {{ user_rating.rating }} â˜… (click star to change)
                        {% else %}
                            Click a star to rate
                        {% endif %}
                    </small>
                </form>
                {% else %}
                    <p>Login to rate this event.</p>
                {% endif %}
            </div>
        </div>

        <!-- comment section -->
        <div class="comments-section">
            {% if user.is_authenticated %}
            <form method="POST">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit">Add Comment</button>
            </form>
            {% endif %}

            <h2>Comments</h2>

            {% for comment in comments %}
            <div class="comment" data-id="{{ comment.id }}">
                <p><strong>{{ comment.user.username }}</strong> said:</p>
                <p>{{ comment.text }}</p>
                <small>{{ comment.created_at|date:"M d, Y H:i "}}</small>

                <div class="reaction-buttons">
                    {% if user.is_authenticated %}
                        <button class="like-btn" data-url="{% url 'toggle_reaction' comment.id 'like' %}">ğŸ‘</button>
                        <span class="like-count">{{ comment|reaction_count:"like" }}</span>

                        <button class="dislike-btn" data-url="{% url 'toggle_reaction' comment.id 'dislike' %}">ğŸ‘</button>
                        <span class="dislike-count">{{ comment|reaction_count:"dislike" }}</span>
                    {% else %}
                        <p>Login to react.</p>
                    {% endif %}
                </div>

                {% if user == comment.user %}
                <div class="actions">
                    <a href="{% url 'edit-comment' comment.pk %}">Edit</a>
                    <a href="{% url 'delete-comments' comment.pk %}">Delete</a>
                </div>
                {% endif %}
            </div>
            {% empty %}
            <hr />
            <p class="no-comments">No comments yet</p>
            {% endfor %}
        </div>
    </div>
</main>
{% endblock %}
